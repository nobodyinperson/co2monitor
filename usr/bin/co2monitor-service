#!/usr/bin/env python3
import logging
import configparser
import sys, os, glob
import csv
import time
import signal
import gettext

# logger
logger = logging.getLogger(__name__)

# add /usr/lib/co2monitor to the module paths
# sys.path.insert(1,os.path.join(os.path.dirname(os.path.realpath(__file__)),
#     '../../usr/lib'))
sys.path.insert(1,"/usr/lib")

# get user system language
user_language = os.environ.get('LANGUAGE','##') # default to a non-existent lang
# init translation
lang = gettext.translation(
    domain    = 'co2monitor',                  # domain
    localedir = '/usr/share/co2monitor/lang',  # language folder
    languages = [user_language.split("_")[0]], # user language
    fallback  = True
    )
lang.install() # install the language

# import co2 device interface
import co2monitor.service

# run the service
service = co2monitor.service.co2monitorService()
# set up config
service.config_setup(glob.glob("/etc/co2monitor/*.conf"))
# set up logging
service.logging_setup()
logger.info(_("co2monitor started!"))
logger.debug(_("command-line arguments: {}").format(sys.argv[1:]))

# the device file
try: # first argument is the device file
    device = sys.argv[1]
    logger.info(_("setting up device '{}'").format(device))
    service.setup_device(device) # setup the device
except: # no device as argument
    logger.critical('No device given as command-line argument. Aborting.')
    sys.exit(1)

# start the logloop
service.logloop()

